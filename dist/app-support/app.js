/*
录音
https://github.com/xiangyuecn/Recorder
src: app-support/app.js,app-support/app-ios-weixin-support.js,app-support/app-native-support.js
*/
!function(){"use strict";var n=/MicroMessenger/i.test(navigator.userAgent),a=window.RecordAppBaseFolder||"/Recorder/dist/",e=window.OnRecordAppInstalled,u=[{Key:"Native",Support:function(e){e(!1)},Config:{}},{Key:"IOS-Weixin",Support:function(e){p.AlwaysUseWeixinJS||!Recorder.Support()?e(n):e(!1)},Config:{WxReady:function(e){e(null,"未实现IOS-Weixin.Config.WxReady")},DownWxMedia:function(e,n,t){t("下载素材接口DownWxMedia未实现")},AMREngine:[{url:a+"engine/beta-amr.js",check:function(){return!Recorder.prototype.amr}}]},ExtendDefault:!0},{Key:"Default",Support:function(e){e(!0)},Config:{paths:[{url:a+"recorder-core.js",check:function(){return!window.Recorder}},{url:a+"engine/mp3.js",check:function(){return!Recorder.prototype.mp3}}]}}],t=u[0],o=u[1],f=u[2];f.RequestPermission=function(e,n){var t=Recorder();t.open(function(){t.close(),e()},n)},f.Start=function(e,n,t){e||(e={});var o=p.__Rec;null!=o&&o.close(),p.__Rec=o=Recorder({type:e.type||"mp3",sampleRate:e.sampleRate||16e3,bitRate:e.bitRate||16,onProcess:function(e,n,t,o){p.ReceivePCM(e[e.length-1],n,t,o)}}),o.open(function(){o.start(),n()},function(e){t(e)})},f.Stop=function(t,n){var e=p.__Rec,o=function(){e.close(),p.__Rec=null};e.stop(function(e,n){o(),p.BlobRead(e,n,t)},function(e){o(),n(e)})};var p={Current:0,BaseFolder:a,AlwaysUseWeixinJS:!1,Platforms:{Native:t,Weixin:o,Default:f},Js:function(i,r,c,e){var s=(e=e||window).document,a=function(e){if(e>=i.length)r();else{var n=i[e],t=n.url;if(!1!==n.check()){var o=s.createElement("script");o.setAttribute("type","text/javascript"),o.setAttribute("src",t),o.onload=function(){a(e+1)},o.onerror=function(e){c("请求失败:"+(e.message||"-")+"，"+t)},s.body.appendChild(o)}else a(e+1)}};a(0)},BlobRead:function(e,n,t){var o=new FileReader;o.onloadend=function(){t({mime:e.type,duration:n,data:(/.+;\s*base64\s*,\s*(.+)$/i.exec(o.result)||[])[1]})},o.readAsDataURL(e)},ReceivePCM:function(e,n,t,o){p.OnProcess&&p.OnProcess([e],n,t,o)},RequestPermission:function(t,o){var i=p.__reqs||(p.__reqs=[]);i.push({s:t,f:o}),t=function(){e("s",arguments)},o=function(){e("f",arguments)};var e=function(e,n){for(var t=0;t<i.length;t++)i[t][e].apply(null,n);i.length=0};if(!(1<i.length)){var r=0,c=function(n,e){if(n.IsInit)e();else{var t=n.Config.paths||[a+"app-support/app-"+n.Key.toLowerCase()+"-support.js"];p.Js(t,function(){n.IsInit=!0,e()},function(e){e="初始化js库失败："+e,console.log(e,n),o(e)})}},s=function(n){if(n)(p.Current=n).RequestPermission(t,o);else{var e=function(){n.Support(function(e){e?c(n,function(){s(n)}):(r++,s())})};(n=u[r]).ExtendDefault?c(f,e):e()}};s(p.Current)}},Start:function(e,n,t){var o=p.Current;if(o){var i={type:"mp3",sampleRate:16e3,bitRate:16};if(e)for(var r in e)i[r]=e[r];o.Start(i,n,t)}else t("需先调用RequestPermission")},Stop:function(e,n){var t=p.Current;t?t.Stop(e,n):n("需先调用RequestPermission")}};window.RecordApp=p,e&&e()}(),function(){"use strict";var c=RecordApp,e=c.Platforms.Weixin,s=e.Config;e.IsInit=!0;var a={};e.RequestPermission=function(t,o){s.WxReady(function(e,n){a.wx=e,n?o("微信JsSDK准备失败："+n):t()})},e.Start=function(e,n,t){a.start=e,a.wx.startRecord({success:function(){n()},fail:function(e){t("无法录音："+e.errMsg)}})},e.Stop=function(i,r){r=function(e){r("录音失败："+(e.errMsg||e))};a.wx.stopRecord({fail:r,success:function(e){var n=e.localId;console.log("微信录音 wx.playVoice({localId:'"+n+"'})"),wx.uploadVoice({localId:n,isShowProgressTips:0,fail:r,success:function(e){var n=e.serverId;console.log("微信录音serverId:"+n),s.DownWxMedia(n,function(e){var o,n;/amr/i.test(e.mime)?(o=e.data,n=function(){for(var e=atob(o),n=e.length,t=new Uint8Array(n);n--;)t[n]=e.charCodeAt(n);Recorder.AMR.decode(t,function(e){var n=a.start;Recorder(n).mock(e,8e3).stop(function(e,n){c.BlobRead(e,n,i)},r)},function(e){r("AMR音频无法解码:"+e)})},Recorder.AMR?n():c.Js(s.AMREngine,n,function(){r("加载AMR转换引擎失败")})):r("微信服务器返回了未知音频类型："+e.mime)},function(e){r("下载音频失败："+e)})}})}})}}(),function(){"use strict";var s=RecordApp,e=s.Platforms.Native;e.Config;e.IsInit=!0,window.NativeRecordReceivePCM=function(e,n,t){for(var o,i=e.length,r=0,c=0;c<i;c++)r+=Math.abs(e[c]);o=(r/=i)<1251?Math.round(r/1250*10):Math.round(Math.min(100,Math.max(0,100*(1+Math.log10(r/1e4))))),s.ReceivePCM(e,o,n,t)},e.RequestPermission=function(e,n){n("未实现RequestPermission调用App原生接口")},e.Start=function(e,n,t){t("未实现Start调用App原生接口")},e.Stop=function(e,n){n("未实现Stop调用App原生接口")}}();