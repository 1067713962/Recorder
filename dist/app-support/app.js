/*
录音
https://github.com/xiangyuecn/Recorder
src: app-support/app.js,app-support/app-ios-weixin-support.js,app-support/app-native-support.js
*/
!function(){"use strict";var n=/MicroMessenger/i.test(navigator.userAgent),u=window.RecordAppBaseFolder||"/Recorder/dist/",e=window.OnRecordAppInstalled,l=[{Key:"Native",Support:function(e){e(!1)},Config:{}},{Key:"IOS-Weixin",Support:function(e){p.AlwaysUseWeixinJS||!Recorder.Support()?e(n):e(!1)},Config:{WxReady:function(e){e(null,"未实现IOS-Weixin.Config.WxReady")},DownWxMedia:function(e,n,t){t("下载素材接口DownWxMedia未实现")},AMREngine:[{url:u+"engine/beta-amr.js",check:function(){return!Recorder.prototype.amr}}]},ExtendDefault:!0},{Key:"Default",Support:function(e){e(!0)},Config:{paths:[{url:u+"recorder-core.js",check:function(){return!window.Recorder}},{url:u+"engine/mp3.js",check:function(){return!Recorder.prototype.mp3}}]}}],t=l[0],o=l[1],f=l[2];f.RequestPermission=function(e,n){var t=Recorder();t.open(function(){t.close(),e()},n)},f.Start=function(e,n,t){var o=p.__Rec;null!=o&&o.close(),p.__Rec=o=Recorder({type:e.type,sampleRate:e.sampleRate,bitRate:e.bitRate,onProcess:function(e,n,t,o){p.ReceivePCM(e[e.length-1],n,t,o)}}),o.appSet=e,o.open(function(){o.start(),n()},function(e){t(e)})},f.Stop=function(t,n){var o=p.__Rec;if(o){var r=function(){for(var e in o.close(),o.set)o.appSet[e]=o.set[e];p.__Rec=null};o.stop(function(e,n){r(),p.BlobRead(e,n,t)},function(e){r(),n(e)})}else n("未开始录音")};var p={LM:"2019-4-23 14:51:14",Current:0,IsWx:n,BaseFolder:u,AlwaysUseWeixinJS:!1,Platforms:{Native:t,Weixin:o,Default:f},Js:function(r,i,a,e){var s=(e=e||window).document,c=function(e){if(e>=r.length)i();else{var n=r[e],t=n.url;if(!1!==n.check()){var o=s.createElement("script");o.setAttribute("type","text/javascript"),o.setAttribute("src",t),o.onload=function(){c(e+1)},o.onerror=function(e){a("请求失败:"+(e.message||"-")+"，"+t)},s.body.appendChild(o)}else c(e+1)}};c(0)},BlobRead:function(e,n,t){var o=new FileReader;o.onloadend=function(){t({mime:e.type,duration:n,data:(/.+;\s*base64\s*,\s*(.+)$/i.exec(o.result)||[])[1]})},o.readAsDataURL(e)},ReceivePCM:function(e,n,t,o){p.OnProcess&&p.OnProcess([e],n,t,o)},Install:function(t,o){var r=p.__reqs||(p.__reqs=[]);r.push({s:t,f:o}),t=function(){i("s",arguments)},o=function(e,n){i("f",arguments)};var i=function(e,n){for(var t=0;t<r.length;t++)r[t][e].apply(null,n);r.length=0};if(!(1<r.length)){var a=0,s=function(n,e){if(n.IsInit)e();else{var t=n.Config.paths||[{url:u+"app-support/app-"+n.Key.toLowerCase()+"-support.js",check:function(){}}];p.Js(t,function(){n.IsInit=!0,e()},function(e){e="初始化js库失败："+e,console.log(e,n),o(e)})}},c=function(n){if(n)p.Current=n,t();else{var e=function(){n.Support(function(e){e?s(n,function(){c(n)}):(a++,c())})};(n=l[a]).ExtendDefault?s(f,e):e()}};c(p.Current)}},RequestPermission:function(n,t){p.Install(function(){var e=p.Current;console.log("开始请求"+e.Key+"录音权限"),e.RequestPermission(function(){console.log("录音权限请求成功"),n()},function(e,n){console.log("录音权限请求失败："+e+",isUserNotAllow:"+n),t(e,n)})},function(e){console.log("Install失败",e),t(e)})},Start:function(e,n,t){var o=p.Current;if(o){e||(e={});var r={type:"mp3",sampleRate:16e3,bitRate:16};for(var i in r)e[i]||(e[i]=r[i]);o.Start(e,function(){console.log("开始录音",e),n()},function(e){console.log("开始录音失败："+e),t(e)})}else t("需先调用RequestPermission")},Stop:function(i,n){var e=p.Current;e?e.Stop(function(e){for(var n=atob(e.data),t=n.length,o=new Uint8Array(t);t--;)o[t]=n.charCodeAt(t);var r=new Blob([o],{type:e.mime});console.log("结束录音"+r.size+"b "+e.duration+"ms",r),i(r,e.duration)},function(e){console.log("结束录音失败："+e),n(e)}):n("需先调用RequestPermission")}};window.RecordApp=p,e&&e()}(),function(){"use strict";var m=RecordApp,e=m.Platforms.Weixin,g=e.Config;e.IsInit=!0;var r={};e.RequestPermission=function(t,o){g.WxReady(function(e,n){r.wx=null,n?o("微信JsSDK准备失败："+n):(r.wx=e,t())})},e.Start=function(e,n,t){var o=r.wx;o?(o.startRecord({success:function(){r.start=e,n()},fail:function(e){t("无法录音："+e.errMsg)}}),r.timeout=[],r.err="",o.onVoiceRecordEnd({complete:function(e){r.timeout.push({res:e,time:Date.now()}),o.startRecord({fail:function(e){r.err="无法接续录音："+e.errMsg}})}})):t("请先调用RequestPermission")},e.Stop=function(f,n){var p=function(e){n("录音失败："+(e.errMsg||e))},d=r.start;if(d){r.start=null;var R={list:[]};d.DownWxMediaData=R;var u=function(){var i=Date.now(),r=R.list;if(r[0].duration)f(r[0]);else{var a=[],s=0,c=0,u=0,l=function(){if(u||(u=Date.now()),c>=r.length)return R.decodeTime=Date.now()-u,void function(){s||(s=Date.now());for(var e=[],n=0;n<a.length;n++)for(var t=a[n],o=0;o<t.length;o++)e.push(t[o]);var r=Recorder(d).mock(e,8e3);r.stop(function(e,n){for(var t in R.encodeTime=Date.now()-s,R.transformTime=Date.now()-i,r.set)d[t]=r.set[t];m.BlobRead(e,n,f)},p)}();for(var e=r[c],n=atob(e.data),t=n.length,o=new Uint8Array(t);t--;)o[t]=n.charCodeAt(t);Recorder.AMR.decode(o,function(e){a.push(e),c++,l()},function(e){p("AMR音频"+(c+1)+"无法解码:"+e)})};Recorder.AMR?l():(console.log("加载AMR转换引擎"),m.Js(g.AMREngine,l,function(){p("加载AMR转换引擎失败")}))}},l=[],t=function(){for(var n=[],e=0;e<v.length;e++)n.push(v[e].res.localId);console.log("结束录音共"+n.length+"段，开始上传下载");var t=0,o=0,r=function(){R.downTime=Date.now()-o,u()},i=function(){if(o||(o=Date.now()),t>=l.length)r();else{var e=l[t];g.DownWxMedia({mediaId:e,transform_mediaIds:l.join(","),transform_type:d.type,transform_bitRate:d.bitRate,transform_sampleRate:d.sampleRate},function(e){R.list.push(e),e.duration?r():/amr/i.test(e.mime)?(t++,i()):p("微信服务器返回了未知音频类型："+e.mime)},function(e){p("下载音频失败："+e)})}},a=0,s=function(){if(a>=n.length)return R.uploadTime=Date.now()-c,void i();var e=n[a];console.log("微信录音片段"+a+" wx.playVoice({localId:'"+e+"'})"),wx.uploadVoice({localId:e,isShowProgressTips:0,fail:p,success:function(e){var n=e.serverId;console.log("serverId:"+n),l.push(n),a++,s()}})},c=Date.now();s()},v=r.timeout;return r.err?(console.error(r.err,v),void p("录制失败，已录制"+v.length+"分钟，但后面出错："+r.err)):v.length&&Date.now()-v[v.length-1].time<900?(r.wx.stopRecord(),void t()):void r.wx.stopRecord({fail:p,success:function(e){v.push({res:e,time:Date.now()}),t()}})}p("未开始录音")}}(),function(){"use strict";var s=RecordApp,e=s.Platforms.Native;e.Config;e.IsInit=!0,window.top.NativeRecordReceivePCM=function(e,n,t){for(var o,r=e.length,i=0,a=0;a<r;a++)i+=Math.abs(e[a]);o=(i/=r)<1251?Math.round(i/1250*10):Math.round(Math.min(100,Math.max(0,100*(1+Math.log10(i/1e4))))),s.ReceivePCM(e,o,n,t)},e.RequestPermission=function(e,n){n("未实现RequestPermission调用App原生接口")},e.Start=function(e,n,t){t("未实现Start调用App原生接口")},e.Stop=function(e,n){n("未实现Stop调用App原生接口")}}();